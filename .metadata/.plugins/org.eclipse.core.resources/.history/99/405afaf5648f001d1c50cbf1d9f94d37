package com.test;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

public class Server {

	String id, pw;
	public static void main(String[] args) {
		System.out.println("서버 실행");
		ServerSocket serverSocket = null;
		ArrayList<PrintWriter> list = new ArrayList<PrintWriter>();
		Map<String, UserInfo> userMap = new HashMap<String, UserInfo>();
		
		File userFile = new File("userList.bin");
		try {
			serverSocket = new ServerSocket(8080);
			while(true) {
				final Socket socket = serverSocket.accept();
				System.out.println("요청 들어옴");
				Thread thr = new Thread(new Runnable() {
					
					@Override
					public void run() {
						// TODO Auto-generated method stub
						InputStream is = null;
						OutputStream os = null;
						
						ObjectInputStream ois = null;
						ObjectOutputStream oos = null;
						
						InetAddress addr = null;
						
						try {
							addr = socket.getInetAddress();
							is = socket.getInputStream();
							os = socket.getOutputStream();
							
							ois = new ObjectInputStream(is);
							oos = new ObjectOutputStream(os);
							HashMap<String, UserInfo> ClientInfo =(HashMap<String, UserInfo>)  ois.readObject();
							//회원가입
							if(ClientInfo.containsKey("join")) { 
								userJoin(ClientInfo);	
							} //회원가입 end
							
							//로그인
							if(ClientInfo.containsKey("login")) {
								userLogin(ClientInfo);
							}//로그인 end
						} catch (IOException e) {
							// TODO Auto-generated catch block
							
						} catch (ClassNotFoundException e) {
							// TODO Auto-generated catch block
							
						}finally {
							try {
								if(oos!=null)oos.close();
								if(ois!=null)ois.close();
								if(os!=null)os.close();
								if(is!=null)is.close();
							} catch (IOException e) {
								// TODO Auto-generated catch block
								e.printStackTrace();
							}
						}
						
						
						
					}//run() end
					
					
					private void userLogin(HashMap<String, UserInfo> clientInfo) {
						// TODO Auto-generated method stub
						
					}


					//회원가입
					private void userJoin(HashMap<String, UserInfo> clientInfo) {
						// TODO Auto-generated method stub
						id = clientInfo.get("join").getUserId();
						pw = clientInfo.get("join").getUserPassword();
						System.out.println(id+" "+pw);
						OutputStream os = null;
						ObjectOutputStream oos =null;
						try {
							if(!userFile.exists()) {
								userFile.createNewFile();
							}
							os = new FileOutputStream(userFile);
							oos = new ObjectOutputStream(os);
							
							oos.writeObject(clientInfo);
							
							System.out.println("회원가입 완료");
						} catch (FileNotFoundException e1) {
							// TODO Auto-generated catch block
							e1.printStackTrace();
						} catch (IOException e1) {
							// TODO Auto-generated catch block
							e1.printStackTrace();
						}finally {
							try {
								if(oos!=null)oos.close();
								if(oos!=null)os.close();
							} catch (IOException e1) {
								// TODO Auto-generated catch block
								e1.printStackTrace();
							}
						}
					} //userJoin end
					
				});
				thr.start();
			}
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}
}
